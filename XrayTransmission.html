<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>X-ray Filter Transmission (demo, 1–150 keV)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Chart.js 用于画图 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    label { display: inline-block; width: 220px; margin-top: 8px; }
    input { padding: 4px; }
    button { margin-top: 15px; padding: 6px 12px; }
    #chart-container { margin-top: 25px; max-width: 900px; }
    .note { font-size: 0.85em; color: #666; max-width: 900px; }
  </style>
</head>

<body>
<h1>X-ray Filter Transmission (demo)</h1>

<p class="note">
  This page estimates the X-ray transmission through a solid filter as a function of photon energy.
  Energy is in keV (1–150 keV range). The attenuation coefficient is modeled approximately as
  &mu;(E) = A · E<sup>-3</sup> with element-dependent A. This is only an order-of-magnitude demo and
  will not exactly reproduce Henke / CXRO results.
</p>

<p class="note">
  Supported elements (case-insensitive): <b>Fe, Ni, Al, Cu, Mg, Ti</b>.
</p>

<h3>Input</h3>

<div>
  <label>Chemical formula (element):</label>
  <input id="formula" type="text" value="Al">
  <br>

  <label>Density (g/cm³):</label>
  <input id="density" type="number" step="0.01" value="-1">
  <span class="note">(negative → use tabulated density)</span>
  <br>

  <label>Thickness (microns):</label>
  <input id="thickness" type="number" step="0.1" min="0" value="1000">
  <br>

  <label>Photon Energy range (keV):</label>
  from
  <input id="Emin" type="number" step="0.1" min="1" value="20">
  to
  <input id="Emax" type="number" step="0.1" max="150" value="25">
  in
  <input id="Npts" type="number" min="10" max="1000" value="100">
  steps
  <br>

  <button onclick="computeTransmission()">Submit Request</button>
</div>

<p id="msg" class="note"></p>

<div id="chart-container">
  <canvas id="txChart"></canvas>
</div>

<script>
let txChart = null;

// 内置密度表 (g/cm^3)
const densityTable = {
  "FE": 7.874,
  "NI": 8.908,
  "AL": 2.700,
  "CU": 8.960,
  "MG": 1.738,
  "TI": 4.506
};

// 演示用 μ(E) = A * E^-3 的系数 A (1/cm·keV^3)
// 只是根据 Z 粗略调了一下量级，不能当作精确 Henke 数据
const muCoeff = {
  "MG": 3e4,
  "AL": 4e4,
  "TI": 1e5,
  "FE": 2e5,
  "NI": 3e5,
  "CU": 4e5
};

// 近似 μ(E) [1/cm]，E_keV 为 keV
function mu_of_E(elemKey, E_keV, density) {
  const base = muCoeff[elemKey] || 5e4;
  const mu_mass = base / Math.pow(E_keV, 3);  // (cm^2/g) 近似
  return mu_mass * density;                   // μ = (μ/ρ)·ρ  [1/cm]
}

function computeTransmission() {
  const formulaInput = document.getElementById("formula").value.trim();
  const elemKey = formulaInput.toUpperCase();
  let rho = parseFloat(document.getElementById("density").value);
  const thickness_um = parseFloat(document.getElementById("thickness").value);
  const Emin = parseFloat(document.getElementById("Emin").value);
  const Emax = parseFloat(document.getElementById("Emax").value);
  const Npts = parseInt(document.getElementById("Npts").value, 10);
  const msg = document.getElementById("msg");

  // 清空提示
  msg.textContent = "";

  // 检查元素
  if (!densityTable[elemKey]) {
    msg.textContent = "Unsupported element. Allowed: Fe, Ni, Al, Cu, Mg, Ti (case-insensitive).";
    return;
  }

  if (isNaN(thickness_um) || thickness_um < 0) {
    msg.textContent = "Please enter a non-negative thickness (microns).";
    return;
  }
  if (isNaN(Emin) || isNaN(Emax) || Emin < 1 || Emax > 150 || Emax <= Emin) {
    msg.textContent = "Photon Energy must satisfy: 1 keV ≤ Emin < Emax ≤ 150 keV.";
    return;
  }
  if (isNaN(Npts) || Npts < 10 || Npts > 1000) {
    msg.textContent = "Number of steps must be between 10 and 1000.";
    return;
  }

  // 处理密度：负值 → 用表
  if (rho < 0) {
    rho = densityTable[elemKey];
  }
  if (isNaN(rho) || rho <= 0) {
    msg.textContent = "Density must be positive (or negative to use a tabulated value).";
    return;
  }

  // μm → cm
  const t_cm = thickness_um * 1e-4;

  const energies = [];
  const transmissions = [];

  const dE = (Emax - Emin) / (Npts - 1);

  for (let i = 0; i < Npts; i++) {
    const E = Emin + i * dE;          // keV
    const mu = mu_of_E(elemKey, E, rho);
    const T = Math.exp(-mu * t_cm);   // Beer–Lambert
    energies.push(E);
    transmissions.push(T);
  }

  msg.textContent =
    `Computed transmission for ${elemKey}, density = ${rho.toFixed(3)} g/cm³, `
    + `thickness = ${thickness_um} µm, energy ${Emin.toFixed(2)}–${Emax.toFixed(2)} keV. `
    + `(Model μ(E) ≈ A·E⁻³, demo only – not exact Henke data.)`;

  const ctx = document.getElementById("txChart").getContext("2d");
  if (txChart) {
    txChart.destroy();
  }

  txChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: energies,
      datasets: [{
        label: "Transmission T(E)",
        data: transmissions,
        fill: false
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          title: { display: true, text: "Photon Energy (keV)" }
        },
        y: {
          title: { display: true, text: "Transmission T(E)" },
          min: 0,
          max: 1
        }
      }
    }
  });
}
</script>
</body>
</html>
