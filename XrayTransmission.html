<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>X-ray Filter Transmission (formal version)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Chart.js 用于画图 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
    h1 { margin-bottom: 0.3em; }
    label { display: inline-block; width: 240px; margin-top: 8px; }
    input, select { padding: 4px; }
    button { margin-top: 15px; padding: 6px 12px; }
    #chart-container { margin-top: 25px; }
    .note { font-size: 0.85em; color: #666; }
    .row { margin-top: 6px; }
  </style>
</head>

<body>
<h1>X-ray Filter Transmission</h1>
<p class="note">
  This tool calculates the transmission of an X-ray beam through a solid filter
  using tabulated mass attenuation coefficients μ/ρ(E) and densities.
  It can be used for the following elements:
  Mg, Li, Al, Ti, Fe, Co, Ni, Cu, Zn, Nb, Mo, Ag, Sn, Ta, W, Pt, Au.
</p>

<div id="load-status" class="note" style="color:blue;">
  Loading data…
</div>

<hr>

<h3>Input</h3>

<div class="row">
  <label for="element">Element:</label>
  <select id="element"></select>
</div>

<div class="row">
  <label for="density">Density ρ (g/cm³):</label>
  <input id="density" type="number" step="0.001" value="-1">
  <span class="note">(Negative → use tabulated density)</span>
</div>

<div class="row">
  <label for="thickness">Thickness (mm):</label>
  <input id="thickness" type="number" step="0.01" min="0" value="1">
</div>

<div class="row">
  <label>Photon energy range (keV):</label>
  from
  <input id="Emin" type="number" step="0.1" value="10">
  to
  <input id="Emax" type="number" step="0.1" value="100">
  in
  <input id="Npts" type="number" step="1" min="10" max="2000" value="200">
  steps
</div>

<p class="note">
  This calculator is intended for photon energies between 2 and 200 keV.
  Input values outside this range will be clipped.
</p>

<button onclick="computeTransmission()">Compute transmission</button>

<p id="msg" class="note"></p>

<div id="chart-container">
  <canvas id="txChart"></canvas>
</div>

<script>
let densityTable = {};      // key: element (e.g. "MG"), value: density
let elementKeys = [];       // 元素 key 顺序（大写）
let elementLabels = {};     // key: "MG" -> label: "Mg"
let muRhoTable = {};        // key: element -> [{E: keV, muRho: cm2/g}, ...]
let dataReady = false;
let txChart = null;

const GLOBAL_E_MIN = 2.0;    // keV
const GLOBAL_E_MAX = 200.0;  // keV

/**
 * 读取 CSV 文本，按行+逗号分割
 */
function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(line => line.trim().length > 0);
  if (!lines.length) return [];
  const rows = [];
  for (const line of lines) {
    const cells = line.split(",").map(c => c.trim());
    rows.push(cells);
  }
  return rows;
}

/**
 * 加载密度和 μ/ρ 数据
 */
async function loadDataFiles() {
  const statusEl = document.getElementById("load-status");
  try {
    // 1. 读取密度表
    const densResp = await fetch("Density_20251209.csv");
    const densText = await densResp.text();
    const densRows = parseCSV(densText);

    if (densRows.length < 2) {
      throw new Error("Density CSV has no data rows.");
    }

    // 第一行是表头，从第二行开始解析
    for (let i = 1; i < densRows.length; i++) {
      const row = densRows[i];
      if (row.length < 2) continue;
      const rawName = row[0].trim();  // 例如 "Mg"
      if (!rawName) continue;
      const key = rawName.toUpperCase();  // 内部统一用大写
      const rho = parseFloat(row[1]);
      if (!isNaN(rho)) {
        densityTable[key] = rho;
        elementKeys.push(key);
        elementLabels[key] = rawName;  // 用原始大小写作显示名称
      }
    }

    // 2. 读取 μ/ρ 表
    const muResp = await fetch("Mass_Attenuation_Coefficient_20251209.csv");
    const muText = await muResp.text();
    const muRows = parseCSV(muText);

    if (muRows.length < 2) {
      throw new Error("Mass attenuation CSV has no data rows.");
    }

    // 为每个元素准备数组
    elementKeys.forEach(k => { muRhoTable[k] = []; });

    // 假设列的顺序是：E_elem1, mu_elem1, E_elem2, mu_elem2, ...
    // 且顺序与 elementKeys 一致
    for (let r = 1; r < muRows.length; r++) {
      const row = muRows[r];
      for (let i = 0; i < elementKeys.length; i++) {
        const eIdx = 2 * i;
        const muIdx = 2 * i + 1;
        if (eIdx >= row.length || muIdx >= row.length) continue;

        const eStr = row[eIdx].trim();
        const muStr = row[muIdx].trim();
        if (!eStr || !muStr) continue;

        const E = parseFloat(eStr);
        const muRho = parseFloat(muStr);
        if (isNaN(E) || isNaN(muRho)) continue;

        const key = elementKeys[i];
        muRhoTable[key].push({ E: E, muRho: muRho });
      }
    }

    // 删除没有数据的元素 + 排序每个元素的能量数组
    elementKeys = elementKeys.filter(k => muRhoTable[k] && muRhoTable[k].length > 0);
    for (const k of elementKeys) {
      muRhoTable[k].sort((a, b) => a.E - b.E);
    }

    // 填充元素下拉菜单（显示 Mg, Al 等，不是 MG, AL）
    const sel = document.getElementById("element");
    sel.innerHTML = "";
    for (const k of elementKeys) {
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = elementLabels[k] || k;
      sel.appendChild(opt);
    }

    statusEl.style.color = "green";
    statusEl.textContent = "Data loaded. Ready to compute.";
    dataReady = true;

  } catch (err) {
    console.error(err);
    statusEl.style.color = "red";
    statusEl.textContent = "Failed to load data: " + err;
  }
}

/**
 * 在 μ/ρ(E) 表中插值获取 muRho(E) [cm^2/g]
 * 简单线性插值；E_keV 在表外时返回端点值
 */
function interpMuRho(elemKey, E_keV) {
  const arr = muRhoTable[elemKey];
  if (!arr || arr.length === 0) return null;

  if (E_keV <= arr[0].E) return arr[0].muRho;
  if (E_keV >= arr[arr.length - 1].E) return arr[arr.length - 1].muRho;

  for (let i = 0; i < arr.length - 1; i++) {
    const e1 = arr[i].E;
    const e2 = arr[i + 1].E;
    if (E_keV >= e1 && E_keV <= e2) {
      const t = (E_keV - e1) / (e2 - e1);
      const mu1 = arr[i].muRho;
      const mu2 = arr[i + 1].muRho;
      return mu1 + t * (mu2 - mu1);
    }
  }
  return null;
}

/**
 * 计算并画图
 */
function computeTransmission() {
  const msg = document.getElementById("msg");
  msg.textContent = "";

  if (!dataReady) {
    msg.textContent = "Data are still loading. Please wait…";
    return;
  }

  const elemKey = document.getElementById("element").value;
  const elemLabel = elementLabels[elemKey] || elemKey;
  let rhoInput = parseFloat(document.getElementById("density").value);
  const t_mm = parseFloat(document.getElementById("thickness").value);
  let Emin = parseFloat(document.getElementById("Emin").value);
  let Emax = parseFloat(document.getElementById("Emax").value);
  const Npts = parseInt(document.getElementById("Npts").value, 10);

  if (isNaN(t_mm) || t_mm < 0) {
    msg.textContent = "Thickness must be a non-negative number (mm).";
    return;
  }
  if (isNaN(Emin) || isNaN(Emax) || Emin <= 0 || Emax <= 0 || Emax <= Emin) {
    msg.textContent = "Energy range must satisfy 0 < Emin < Emax.";
    return;
  }
  if (isNaN(Npts) || Npts < 10 || Npts > 2000) {
    msg.textContent = "Number of steps must be between 10 and 2000.";
    return;
  }

  // 密度：若 <=0，则用表中数据
  if (isNaN(rhoInput) || rhoInput <= 0) {
    rhoInput = densityTable[elemKey];
  }

  const muArr = muRhoTable[elemKey];
  if (!muArr || muArr.length === 0) {
    msg.textContent = "No μ/ρ data for element " + elemLabel;
    return;
  }
  const EminTable = muArr[0].E;
  const EmaxTable = muArr[muArr.length - 1].E;

  // 将用户设定的范围限制在 [2, 200] keV 以及表格范围内
  let EminClipped = Math.max(Emin, GLOBAL_E_MIN, EminTable);
  let EmaxClipped = Math.min(Emax, GLOBAL_E_MAX, EmaxTable);
  if (EmaxClipped <= EminClipped) {
    msg.textContent = "Requested range is outside the valid 2–200 keV / tabulated range.";
    return;
  }

  const t_cm = t_mm * 0.1;  // mm → cm

  const energies = [];
  const transmissions = [];
  const dE = (EmaxClipped - EminClipped) / (Npts - 1);

  for (let i = 0; i < Npts; i++) {
    const E = EminClipped + i * dE;         // keV
    const muRho = interpMuRho(elemKey, E);  // cm^2/g
    if (muRho === null) continue;
    const mu = muRho * rhoInput;            // 1/cm
    const T = Math.exp(-mu * t_cm);

    const E_label = Number(E.toPrecision(3));  // 3 位有效数字
    energies.push(E_label);
    transmissions.push(T);
  }

  // 计算 y 轴范围：在 min/max 的基础上扩展 ±20%，再限制在 [0,1]
  let ymin = Math.min(...transmissions);
  let ymax = Math.max(...transmissions);
  const range = ymax - ymin;
  let margin = (range === 0) ? 0.05 : 0.2 * range;
  ymin = Math.max(0, ymin - margin);
  ymax = Math.min(1, ymax + margin);
  if (ymin >= ymax) { // 极端情况下兜底
    ymin = Math.max(0, ymin - 0.1);
    ymax = Math.min(1, ymax + 0.1);
  }

  msg.textContent =
    `Computed transmission for ${elemLabel}, density ρ = ${rhoInput.toFixed(3)} g/cm³, ` +
    `thickness = ${t_mm.toFixed(3)} mm, energy ${EminClipped.toFixed(3)}–${EmaxClipped.toFixed(3)} keV ` +
    `(${Npts} points).`;

  const ctx = document.getElementById("txChart").getContext("2d");
  if (txChart) {
    txChart.destroy();
  }

  txChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: energies,
      datasets: [{
        label: "Transmission",
        data: transmissions,
        fill: false
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          title: { display: true, text: "Photon Energy (keV)" },
          ticks: {
            callback: function(value, index, ticks) {
              const v = this.getLabelForValue(value);
              return Number(v).toPrecision(3);
            }
          }
        },
        y: {
          title: { display: true, text: "Transmission" },
          min: ymin,
          max: ymax
        }
      }
    }
  });
}

// 页面加载后自动读取 CSV
loadDataFiles();
</script>

<hr>
<p class="note" style="text-align:center;">
  © 2025 Gaoming Zhu.
  This tool uses tabulated X-ray attenuation data derived from publicly available NIST databases.
  NIST is not affiliated with, does not endorse, and is not responsible for this tool.
  All data are provided strictly for scientific and educational use, not for commercial purposes.
</p>

</body>
</html>
